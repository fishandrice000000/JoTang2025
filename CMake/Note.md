# Makefile & CMakeListsç¬”è®°

## 1. ä» C æºç åˆ°å¯æ‰§è¡Œæ–‡ä»¶çš„å®Œæ•´æµç¨‹

### 1.1 é¢„å¤„ç†

è¾“å…¥`.c`æ–‡ä»¶, è¾“å‡º`.i`æ–‡ä»¶

- åœ¨è¿™ä¸€æ­¥:

  - å¤„ç†é‚£äº›é¢„å¤„ç†æŒ‡ä»¤, å¦‚ `#define`, `#include`, `#ifdef`, `#ifndef`


  - åˆ é™¤æ³¨é‡Š`// you cannot see me`


### 1.2 ç¼–è¯‘

è¾“å…¥`.i`æ–‡ä»¶, è¾“å‡ºæ±‡ç¼–è¯­è¨€æ–‡ä»¶, ä¹Ÿå°±æ˜¯ä»‹äºæºç å’Œæœºå™¨ç ä¹‹é—´çš„ä»£ç 

å¦‚æœå¹³å°ä¸åŒ, ç”Ÿæˆçš„æ±‡ç¼–è¯­è¨€ä¹Ÿä¼šä¸åŒ

- åœ¨è¿™ä¸€æ­¥:
  - æ£€æŸ¥è¯æ³•å’Œè¯­æ³•é”™è¯¯ `int mian â‰  int main`


### 1.3 æ±‡ç¼–

è¾“å…¥æ±‡ç¼–è¯­è¨€æ–‡ä»¶, è¾“å‡ºæºç å¯¹åº”çš„æœºå™¨ç æ–‡ä»¶

- åœ¨è¿™ä¸€æ­¥:
  - é€æ¡ç¿»è¯‘æ±‡ç¼–è¯­è¨€ä¸ºæœºå™¨æŒ‡ä»¤ `ğŸ¤–:01001000 01100101 01101100 01101100 01101111 00100001`


### 1.4 é“¾æ¥

è¾“å…¥å¤šä¸ªæ–‡ä»¶, è¾“å‡ºå•ä¸€çš„å¯æ‰§è¡Œæ–‡ä»¶

- åœ¨è¿™ä¸€æ­¥:

  - æŠŠä¸€å †ç›®æ ‡æ–‡ä»¶å’Œåº“æ–‡ä»¶å·´æ‹‰å·´æ‹‰éƒ½ç»„ç»‡åœ¨ä¸€èµ·

  - å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„å¯æ‰§è¡Œæ–‡ä»¶


### 1.5 æ€»ç»“

â€‹       é¢„å¤„ç†           ç¼–è¯‘                 æ±‡ç¼–                é“¾æ¥

`.c` -----------> `.i` -----------> `.s` -----------> `.o` -----------> `å¯æ‰§è¡Œæ–‡ä»¶`

---

## 2. å®Œæˆç»™å®šçš„Task

### 2.1 ä»»åŠ¡ä¸€ ï¼šç¼–è¯‘å‘½ä»¤å°è¯•ç‰›åˆ€

```bash
# å°†æºç è¿›è¡Œé¢„å¤„ç†, å¹¶å°†å¤„ç†åçš„æ–‡æœ¬è¾“å‡ºåˆ°è¾“å‡ºæµä¸­
gcc -E <file>

# å°†æ–‡ä»¶ç¿»è¯‘æˆæ±‡ç¼–è¯­è¨€
gcc -S <file>

# å°†æ–‡ä»¶ç¿»è¯‘æˆæœºå™¨ç , å˜æˆç›®æ ‡æ–‡ä»¶
gcc -c <file>

# å°†æ–‡ä»¶ç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶
gcc <file>

# å‚æ•°-o, å¯æŒ‡å®šæ–‡ä»¶ç¼–è¯‘è¾“å‡ºçš„æ–‡ä»¶å
gcc <file> -o <filename>
```

### 2.2 ä»»åŠ¡äºŒï¼šMakefileå¤§å±•æ‰‹è„š

#### 2.2.1 Makefileçš„è§„åˆ™

**è§„åˆ™**å°±æ˜¯Makefileæ‰§è¡Œå‘½ä»¤çš„æœ€å°æ¨¡å—ï¼Œä¸€èˆ¬æœ‰ä»¥ä¸‹å½¢å¼: 

```makefile
target : prerequisites
	recipe
```

- `target`:  æœŸæœ›çš„ç¼–è¯‘ç»“æœæ–‡ä»¶çš„æ–‡ä»¶å, ä¸€èˆ¬æ˜¯`.o`æ–‡ä»¶

- `prerequisites`: ç¼–è¯‘`target`æ‰€ä¾èµ–çš„æ–‡ä»¶, ä¸€èˆ¬åŒ…æ‹¬`target`å¯¹åº”çš„æºç æ–‡ä»¶`.c`, ä»¥åŠå…¶æ‰€å¼•ç”¨çš„å¤´æ–‡ä»¶`.h`, æˆ–è€…å…¶å®ƒçš„`.o`æ–‡ä»¶

- `recipe`: å¯¹åº”çš„`target`æ‰€ä¼šæ‰§è¡Œçš„æŒ‡ä»¤, ä¸€èˆ¬åŒ…æ‹¬`cc -c target.c`

#### 2.2.2 å˜é‡çš„ä½¿ç”¨

```makefile
# å£°æ˜å˜é‡
var = main.o foo.o bar.o

# é€šè¿‡$()æ¥å¼•ç”¨å˜é‡
whatiwant : $(var)
	cc -o whatiwant $(var)
	
main.o : main.c apple.h
	cc -c main.c
	
foo.o : foo.c apple.h banana.h
	cc -c foo.c

bar.o : bar.c banana.h cherry.h
	cc -c bar.c
```

#### 2.2.3 è‡ªåŠ¨æ¨å¯¼

```makefile
var = main.o foo.o bar.o

# é€šè¿‡$()æ¥å¼•ç”¨å˜é‡
whatiwant : $(var)
	cc -o whatiwant $(var)

# æ–‡ä»¶***.c å’Œ å‘½ä»¤cc -o ***.c ä¼šè¢«GNUè‡ªåŠ¨æ¨å¯¼å‡ºæ¥
# ç›®æ ‡æ–‡ä»¶ä¸»å¯¼çš„å†™æ³•
main.o : apple.h
foo.o : apple.h banana.h
bar.o : banana.h cherry.h

# ä¾èµ–æ–‡ä»¶ä¸»å¯¼çš„å†™æ³•
main.o foo.o : apple.h
foo.o bar.o : banan.h
bar.o : cherry.h
```

#### 2.2.4 Makefileçš„åŸç†

- å¯»æ‰¾ç¬¬ä¸€ä¸ªç›®æ ‡æ–‡ä»¶
- å†æ ¹æ®å®ƒçš„`prerequisites`æ¥ç”Ÿæˆæ‰€éœ€çš„ç›®æ ‡æ–‡ä»¶
- åœ¨ç”Ÿæˆè¿™äº›æ‰€éœ€çš„ç›®æ ‡æ–‡ä»¶æ—¶, ç»§ç»­ç”Ÿæˆå®ƒä»¬çš„`prerequisites`æ‰€éœ€è¦çš„ç›®æ ‡æ–‡ä»¶
- å¦‚æ­¤é€’å½’ç›´åˆ°ç”Ÿæˆå®Œæ¯•
- æ²¡æœ‰è¢«ç”¨åˆ°çš„è§„åˆ™å¯ä»¥é€šè¿‡`make <target>`æ¥å•ç‹¬è°ƒç”¨

#### 2.2.5 è‡ªå®šä¹‰å¿«æ·å‘½ä»¤

åˆ©ç”¨ä¸Šæ–‡è¯´åˆ°çš„æœ€åä¸€æ¡æ€§è´¨, è‡ªå®šä¹‰ä¸€ä¸ªæ¸…é™¤åƒåœ¾æ–‡ä»¶çš„å‘½ä»¤`clean`

```makefile
var = main.o foo.o bar.o

whatiwant : $(var)
	cc -o whatiwant $(var)

main.o : apple.h
foo.o : apple.h banana.h
bar.o : banana.h cherry.h

# ä½¿ç”¨.PHONYç¡®ä¿cleanä¸ä¼šè¢«çœŸçš„è¯†åˆ«ä¸ºä¸€ä¸ªæ–‡ä»¶, ä»¥å…è«åå…¶å¦™å‡ºç°ä¸€å †clean.o
.PHONY : clean 
clean : 
# åœ¨rmå‰åŠ ä¸Š-, ç¡®ä¿å¦‚æœéƒ¨åˆ†ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨, å…¶ä½™ç›®æ ‡æ–‡ä»¶ä¹Ÿèƒ½è¢«æ­£å¸¸åˆ é™¤
	-rm whatiwant $(var)
```

#### 2.2.6 æ›´å¤šå‘½ä»¤å’Œä¸€äº›å¸¸ç”¨çš„ç‰¹æ®Šå˜é‡

```makefile
# å½“makeæ— æ³•åœ¨å½“å‰ç›®å½•æœç´¢åˆ°æ‰€éœ€æ–‡ä»¶æ—¶, ä¼šæ¥ç€è¯•å›¾åœ¨é€šè¿‡è¯¥å˜é‡æŒ‡å®šçš„ç›®å½•<dir>ä¸­å¯»æ‰¾
# ç›®å½•<dir>ä¹‹é—´ç”¨å†’å·åˆ†éš”, å¦‚ foo:../bar
VPATH = <dir>
```

```makefile
# ä¸ºç¬¦åˆæ¨¡å¼<pattern>çš„æ–‡ä»¶æŒ‡å®šæœç´¢ç›®å½•<dir>
# <dir>ä¸ºç©º, åˆ™æ¸…é™¤å¯¹åº”æ–‡ä»¶å·²æŒ‡å®šçš„æœç´¢ç›®å½•
# <pattern>éœ€è¦åŒ…å«å­—ç¬¦%æ¥ä½œä¸ºé€šé…ç¬¦, å¦‚%.cä»£è¡¨ç€æ‰€æœ‰.cç»“å°¾çš„æ–‡ä»¶
vpath <pattern> <dir>
```

```makefile
#éƒ¨åˆ†è‡ªåŠ¨åŒ–å˜é‡

#å½“å‰è§„åˆ™çš„ç›®æ ‡æ–‡ä»¶å
$@ 

#è§„åˆ™çš„ç¬¬ä¸€ä¸ªä¾èµ–é¡¹
$< 

#è§„åˆ™ä¸­çš„æ‰€æœ‰ä¾èµ–é¡¹
$^
```

```makefile
# é€šé…ç¬¦ %
# ä¸‹é¢è¿™ä¸ªè§„åˆ™çš„æ„ä¹‰æ˜¯: æ‰€æœ‰çš„.oæ–‡ä»¶éƒ½æ˜¯ç”±.cæ–‡ä»¶ç¼–è¯‘æ¥çš„
%.o : %.c
	gcc -c $@ -o $<
```